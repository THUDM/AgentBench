# æ¡†æ¶å…¥å£

[ğŸŒEnglish](Entrance_en.md)

æ¡†æ¶ä¸»è¦çš„å…¥å£æ˜¯ï¼š

- `src.server.task_controller`: ç”¨äºæ‰‹åŠ¨å¯åŠ¨task_controllerã€‚
- `src.start_task`: ç”¨äºå¯åŠ¨task_workerã€‚
- `src.assigner`: ç”¨äºå¯åŠ¨è¯„æµ‹ã€‚
- `src.server.task_worker`: ç”¨äºæ‰‹åŠ¨å¯åŠ¨task_workerã€‚

## src.server.task_controller

task_controlleræ˜¯task serverçš„æ ¸å¿ƒï¼Œç”¨äºç®¡ç†æ‰€æœ‰çš„task_workerã€‚
task_controlleråº”è¯¥æ˜¯æœ€å…ˆå¯åŠ¨çš„ï¼Œä¸”æ¨èå¸¸å¼€ï¼Œå¦‚æ— å¿…è¦ä¹Ÿå»ºè®®å…¨å±€å”¯ä¸€ã€‚
task_controlleré»˜è®¤è¿è¡Œåœ¨5000ç«¯å£ï¼Œä¹Ÿå¯ä»¥é€šè¿‡`--port -p`å‚æ•°æŒ‡å®šã€‚
æ‰€æœ‰æ¥å£æœ‰ç»Ÿä¸€çš„å‰ç¼€`/api/`ã€‚

ä¸€ä¸ªå¯åŠ¨task_controllerå¹¶æŒ‡å®šå…¶è¿è¡Œåœ¨3000ç«¯å£çš„ç¤ºä¾‹ï¼š

```bash
python -m src.server.task_controller -p 3000
```

task_controlleræœ‰ä»¥ä¸‹å‡ ä¸ªç”¨äºç›‘æ§çš„æ¥å£ï¼š

| æ¥å£             | æ–¹æ³•   | å‚æ•° | è¯´æ˜                                                   |
|----------------|------|----|------------------------------------------------------|
| /list_workers  | GET  | æ—   | è¿”å›æ‰€æœ‰çš„task_worker                                     |
| /list_sessions | GET  | æ—   | è¿”å›æ‰€æœ‰çš„session                                         |
| /sync_all      | POST | æ—   | åŒæ­¥æ‰€æœ‰çš„task_workerä¸Šæ­£åœ¨è¿è¡Œçš„sessionï¼Œå¦‚controlleræ„å¤–é‡å¯åº”å…ˆè°ƒç”¨æ­¤æ¥å£ |
| /cancel_all    | POST | æ—   | å–æ¶ˆæ‰€æœ‰çš„task_workerä¸Šæ­£åœ¨è¿è¡Œçš„session                        |

## src.start_task

start_taskæ˜¯ç”¨äºå¯åŠ¨task_workerçš„è„šæœ¬ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯è¯»å–é…ç½®æ–‡ä»¶å¹¶å¯åŠ¨task_workerã€‚
start_taskçš„é…ç½®æ–‡ä»¶æ˜¯`configs/start_task.yaml`ï¼Œå…·ä½“è¯¦è§é…ç½®æ–‡ä»¶ä»‹ç»ã€‚

start_taskçš„å‚æ•°å¦‚ä¸‹ï¼š

- `[--config CONFIG]`: æŒ‡å®šè¦è¯»å–çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸º`configs/start_task.yaml`ï¼Œé€šå¸¸æ²¡æœ‰å¿…è¦æ›´æ”¹ã€‚
- `[--start | -s [TASK_NAME NUM [TASK_NAME NUM ...]]]`: æŒ‡å®šè¦å¯åŠ¨çš„ä»»åŠ¡ï¼Œæ ¼å¼ä¸º`TASK_NAME NUM`ï¼Œå…¶ä¸­`TASK_NAME`
  æ˜¯ä»»åŠ¡åç§°ï¼Œ`NUM`æ˜¯éœ€è¦å¯åŠ¨çš„workerçš„ä¸ªæ•°ï¼Œå¦‚æ­¤å‚æ•°è¢«æŒ‡å®šåˆ™å°†è¦†ç›–**æ‰€æœ‰**é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®ã€‚
- `[--auto-controller | -a]`: æŒ‡å®šæ˜¯å¦è‡ªåŠ¨å¯åŠ¨task_controllerï¼Œé»˜è®¤ä¸ºå¦ã€‚
- `[--base-port | -p PORT]`:
  æŒ‡å®štask_workerçš„åŸºç¡€ç«¯å£ï¼Œé»˜è®¤ä¸º5001ï¼Œtask_workerå°†ä»PORTå¼€å§‹ä¾æ¬¡å¯åŠ¨task_workerã€‚å¦‚è‹¥å…±æœ‰Nä¸ªtask_workerï¼Œé‚£ä¹ˆtask_workerçš„ç«¯å£å°†ä»PORTåˆ°PORT+N-1ã€‚

## src.assigner

assigneræ˜¯ç”¨äºå¯åŠ¨è¯„æµ‹çš„è„šæœ¬ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯è¯»å–é…ç½®æ–‡ä»¶å¹¶å¯åŠ¨è¯„æµ‹ï¼Œå¹¶å°†ç»“æœå®æ—¶ä¿å­˜åœ¨æŒ‡å®šçš„è¾“å‡ºæ–‡ä»¶å¤¹ä¸­ã€‚

assignerçš„å‚æ•°å¦‚ä¸‹ï¼š

- `[--config CONFIG]`: æŒ‡å®šè¦è¯»å–çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸º`configs/assignments/default.yaml`ã€‚
- `[--auto-retry]`: è‡ªåŠ¨é‡æ–°æµ‹è¯•å¤±è´¥çš„æ ·ä¾‹

å¦‚é…ç½®æ–‡ä»¶ä¸­çš„`output`å­—æ®µçš„å€¼ä¸­å«æœ‰`{TIMESTAMP}`ï¼Œåˆ™æ­¤å¤„å°†ä¼šè¢«æ›¿æ¢ä¸ºå½“å‰æ—¶é—´å¹¶ç»§ç»­åç»­çš„æ“ä½œï¼ˆå³ç›¸åŒçš„é…ç½®æ–‡ä»¶å¯èƒ½ä¼šæœ‰ä¸åŒçš„è¾“å‡ºæ–‡ä»¶å¤¹ï¼‰ã€‚

å¦‚æœé…ç½®ä¸­`output`å­—æ®µæŒ‡å®šçš„ç›®å½•å·²ç»å­˜åœ¨ï¼Œåˆ™assignerå°†ä¼šå°è¯•ä»æ­¤æ–‡ä»¶å¤¹ä¸­è¯»å–å·²æœ‰çš„è¯„æµ‹ç»“æœï¼Œåœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­è¯„æµ‹ã€‚

assigner**æ¯æ¬¡**å¯åŠ¨éƒ½ä¼šå°†è¯»å–çš„é…ç½®æ–‡ä»¶è§£æå¹¶å­˜å‚¨åˆ°`output`å­—æ®µæŒ‡å®šçš„ç›®å½•ä¸­ï¼Œ**å¦‚ç›®å½•ä¸­å·²æœ‰é…ç½®æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†è¢«è¦†ç›–**ã€‚

## src.server.task_worker

ä¸€ä¸ªtask_workerå¯¹åº”äº†ä¸€ä¸ªä»»åŠ¡è¿›ç¨‹ï¼ŒåŒæ ·çš„ä»»åŠ¡å¯ä»¥æœ‰å¤šä¸ªtask_workerã€‚
å¦‚æ— å¿…è¦ï¼Œ**ä¸æ¨è**æ‰‹åŠ¨å¯åŠ¨task_workerï¼Œè€Œæ˜¯é€šè¿‡`src.start_task`å¯åŠ¨ã€‚

task_workerçš„å‚æ•°å¦‚ä¸‹ï¼š

- `NAME` ä»»åŠ¡åç§°ï¼Œç”¨äºæŒ‡å®šè¦å¯åŠ¨çš„ä»»åŠ¡ã€‚
- `[--config | -c CONFIG]` æŒ‡å®šè¦è¯»å–çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸º`configs/tasks/task_assembly.yaml`ã€‚
- `[--port | -p PORT]` æŒ‡å®štask_workerçš„ç«¯å£ï¼Œé»˜è®¤ä¸º5001ã€‚
- `[--controller | -C ADDRESS]` æŒ‡å®štask_controllerçš„åœ°å€ï¼Œé»˜è®¤ä¸ºhttp://localhost:5000/api ã€‚
- `[--self ADDRESS]` æŒ‡å®štask_workerçš„åœ°å€ï¼Œé»˜è®¤ä¸ºhttp://localhost:5001/api
  ï¼Œæ­¤åœ°å€å°†ä¼šè¢«task_controllerç”¨äºä¸task_workeré€šä¿¡ï¼Œæ‰€ä»¥éœ€è¦ç¡®ä¿task_controllerèƒ½å¤Ÿè®¿é—®åˆ°æ­¤åœ°å€ã€‚
